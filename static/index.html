<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPulse Analytics Platform: See into the heart of the market.</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Mobile Responsive CSS -->
    <link rel="stylesheet" href="css/mobile-responsive.css">
    <!-- Accessibility CSS -->
    <link rel="stylesheet" href="css/accessibility.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <!-- Bootstrap JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
      body { font-family: 'Open Sans', sans-serif; background-color: #f8f9fa; }
      h1, h3 { font-family: 'Abril Fatface', cursive; }
      .card { border-radius: 12px; }
      .sidebar { min-width: 260px; max-width: 320px; }
      .content-area { flex: 1 1 auto; }
      .topbar { height: 64px; display:flex; align-items:center; gap:16px; }
      .filter-section { max-height: 60vh; overflow:auto; }
      .clickable { cursor:pointer; }
      .sent-pos { color: #198754; } /* bootstrap success green */
      .sent-neg { color: #dc3545; }  /* bootstrap danger red */
      .sent-ntrl { color: #6c757d; } /* neutral gray */

      /* Enhanced article display */
      .list-group-item {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
        margin-bottom: 0.5rem;
        border-radius: 8px !important;
      }

      .list-group-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #198754;
      }

      /* Sentiment badge styling */
      .sentiment-badge {
        font-weight: 600;
        letter-spacing: 0.02em;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      /* Article content typography */
      .article-content {
        font-family: 'Georgia', serif;
        line-height: 1.7;
        color: #2c3e50;
      }

      .article-content p {
        margin-bottom: 1.2rem;
      }

      .article-content p:first-child {
        font-size: 1.05rem;
        font-weight: 400;
      }

      /* Modal improvements */
      .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      }

      .modal-header {
        border-bottom: 2px solid #e9ecef;
        padding: 1.5rem;
      }

      .modal-body {
        padding: 1.5rem;
      }

      /* Sentiment indicator styling */
      .sentiment-indicator {
        font-weight: 600;
        letter-spacing: 0.02em;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid;
        border-color: inherit;
      }

      .small-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; }
      /* Chart container styling - prevent infinite growth */
      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-bottom: 1rem;
      }
      .chart-container.small {
        height: 200px;
      }
      .chart-container canvas {
        max-width: 100% !important;
        max-height: 100% !important;
      }
      #sentimentChart, #priceChart, #indicesChart, #sentimentTrendChart, #priceSentimentOverlay {
        max-width: 100%;
      }
      /* API status indicator removed from topbar */
      
      /* Loading indicators */
      .loading-indicator {
        min-width: 250px;
        max-width: 400px;
      }
      
      /* Toast notifications */
      .toast-container {
        z-index: 9999;
      }
      
      /* Skeleton loader */
      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
      }
      
      @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      
      /* Pulse animation for live badge */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Skeleton loader */
      .skeleton { position: relative; overflow: hidden; background: #e9ecef; border-radius: 8px; }
      .skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%);
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
        animation: shimmer 1.2s infinite; }
      @keyframes shimmer { 100% { transform: translateX(100%); } }
    </style>
</head>
<body class="bg-light">
  <div class="container-fluid p-3">
    <!-- Top bar -->
    <div class="d-flex justify-content-between align-items-center topbar mb-3">
      <div class="d-flex align-items-center gap-3">
        <h3 class="mb-0">MarketPulse Analytics Platform</h3>
        <small class="text-muted">Sentiment-driven stock insights</small>
      </div>

      <div class="d-flex align-items-center gap-3">
        <!-- Authentication Section -->
        <div class="d-flex align-items-center gap-2" id="authSection">
          <!-- Welcome message and user controls (shown when logged in) -->
          <span id="welcomeMessage" class="text-muted small user-only" style="display: none;">
            Welcome, <span id="usernameDisplay"></span>
          </span>
          <a href="profile.html" id="profileIcon" class="user-only" style="display: none; text-decoration: none; color: #667eea; font-size: 1.2rem; margin-left: 0.5rem;" title="Profile">
            <i class="bi bi-person-circle"></i>
          </a>
          <button class="btn btn-sm btn-danger logout-link" onclick="window.auth.logout()" style="display: none;">Logout</button>
          
          <!-- Login/Signup buttons (shown when not logged in) -->
          <a href="login.html" class="btn btn-sm btn-outline-primary login-link">Login</a>
          <a href="register.html" class="btn btn-sm btn-outline-secondary login-link">Sign Up</a>
        </div>
      </div>
    </div>

    <div class="d-flex gap-3">
      <!-- Sidebar Overlay (Mobile) -->
      <div class="sidebar-overlay"></div>
      
      <!-- Sidebar -->
      <aside class="sidebar bg-white p-3 shadow-sm rounded" role="complementary" aria-label="Filters and quick actions">
        <h6>Filters & Search</h6>
        <div class="filter-section mb-3">
          <label class="form-label small">Date Range</label>
          <select id="dateRange" class="form-select form-select-sm mb-3">
            <option value="1">Day</option>
            <option value="7" selected>Week</option>
            <option value="30">Month</option>
          </select>

          <label class="form-label small">Ticker Search</label>
          <input id="tickerSearch" class="form-control form-control-sm mb-2" placeholder="e.g., AAPL, MSFT, GOOGL">
          <button id="applySearch" class="btn btn-sm btn-primary w-100 mb-3">Apply</button>
          <select id="sectorSelect" class="form-select form-select-sm mb-2" style="display: none;">
            <option value="">All sectors</option>
            <option value="Technology">Technology</option>
            <option value="Financials">Financials</option>
            <option value="Energy">Energy</option>
          </select>

          <label class="form-label small mt-2" style="display: none;">News sources / Social</label>
          <select id="sourceSelect" class="form-select form-select-sm mb-2" style="display: none;">
            <option value="">All</option>
            <option value="Reuters">Reuters</option>
            <option value="Bloomberg">Bloomberg</option>
            <option value="Twitter">Twitter</option>
          </select>

          <label class="form-label small mt-2">Sentiment type</label>
          <div class="mb-2">
            <select id="sentimentType" class="form-select form-select-sm">
              <option value="">All</option>
              <option value="positive">Positive</option>
              <option value="negative">Negative</option>
              <option value="neutral">Neutral</option>
            </select>
          </div>

          <label class="form-label small mt-2" style="display: none;">Keywords</label>
          <input id="keywordFilter" class="form-control form-control-sm mb-2" placeholder="e.g. AI, Oil, EV" style="display: none;">

          <button id="applyFilters" class="btn btn-sm btn-outline-primary w-100">Apply Filters</button>
        </div>

        <hr>

        <h6>Quick Actions</h6>
        <div class="d-grid gap-2">
          <button id="btnExportCSV" class="btn btn-sm btn-outline-secondary">Export CSV</button>
          <button id="btnRunAlerts" class="btn btn-sm btn-warning">Run Alerts</button>
        </div>
      </aside>

      <!-- Main content -->
      <main class="content-area" id="main-content" role="main">
        <!-- KPI Cards -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="card p-3 shadow-sm">
              <small>Total Companies</small>
              <h4 id="totalCompanies">—</h4>
            </div>
          </div>
        </div>

        <!-- Stock Performance Overview -->
        <section class="card p-3 mb-3 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center gap-3">
              <h5 class="mb-0">Stock Performance Overview</h5>
              <span id="dataSourceBadge" class="badge text-bg-light">—</span>
            </div>
            <div class="d-flex align-items-center gap-3">
              <small id="lastUpdated" class="text-muted">—</small>
              <button id="btnToggleCandlestick" class="btn btn-sm btn-outline-secondary" style="display: none;">Toggle Candlestick</button>
            </div>
          </div>

          <div class="row">
            <div class="col-lg-9">
              <div class="chart-container">
                <div id="priceChartSkeleton" class="skeleton w-100 h-100 position-absolute"></div>
                <canvas id="priceChart"></canvas>
              </div>
            </div>
            <div class="col-lg-3">
              <!-- Company Performance Summary (using database views) -->
              <div id="companyPerformanceCard" class="card p-3 shadow-sm">
                <h6 class="mb-3">Company Performance Summary</h6>
                <div id="companyPerformanceContent">
                  <p class="text-muted small">Select a ticker to view performance</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Market Indices Overview -->
        <section class="card p-3 mb-3 shadow-sm">
          <h5>Market Indices Overview</h5>
          <div class="chart-container small">
            <canvas id="indicesChart"></canvas>
          </div>
          <div class="d-flex gap-2 mt-2" id="indexCards">
            <!-- dynamic index cards -->
          </div>
        </section>

        <!-- Advanced Analytics Section (Task 55-56) -->
        <section class="card p-3 mb-3 shadow-sm" id="advancedAnalyticsSection">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-graph-up"></i> Advanced Analytics</h5>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="refreshAnalytics()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
              <button class="btn btn-outline-secondary" onclick="toggleAnalytics()">
                <i class="bi bi-chevron-up" id="analyticsToggleIcon"></i>
              </button>
            </div>
          </div>
          <div id="advancedAnalyticsContent">
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#windowFunctions" type="button">
                  Window Functions
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sectorPerformance" type="button">
                  Sector Performance
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#rollingAgg" type="button">
                  Rolling Aggregations
                </button>
              </li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="windowFunctions" role="tabpanel">
                <div id="windowFunctionsContainer">
                  <div class="text-center text-muted py-4">
                    <p class="mt-2">Loading window functions data...</p>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="sectorPerformance" role="tabpanel">
                <div id="sectorPerformanceContainer">
                  <div class="text-center text-muted py-4">
                    <p class="mt-2">Loading sector performance...</p>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="rollingAgg" role="tabpanel">
                <div id="rollingAggregationsContainer">
                  <div class="text-center text-muted py-4">
                    <p class="mt-2">Loading rolling aggregations...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Materialized Views Section (Task 56) -->
        <section class="card p-3 mb-3 shadow-sm" id="materializedViewsSection">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-table"></i> Materialized Views</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshMaterializedView()">
              <i class="bi bi-arrow-clockwise"></i> Refresh View
            </button>
          </div>
          <div id="materializedViewContainer">
            <div class="text-center text-muted py-4">
              <p class="mt-2">Loading materialized view data...</p>
            </div>
          </div>
        </section>

        <!-- News & Sentiment Insights Section -->
        <section class="card p-3 mb-3 shadow-sm" id="newsSentimentSection">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-newspaper"></i> News & Sentiment Insights</h5>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <h6>Topic Highlights</h6>
              <div id="topicHighlights" class="card p-3 bg-light">
                <div class="text-center text-muted">Loading...</div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <h6>Sentiment Trend</h6>
              <div class="chart-container small">
                <canvas id="sentimentTrendChart"></canvas>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <h6>Recent Headlines</h6>
            <div id="newsFeed" class="list-group">
              <div class="text-center text-muted py-3">Loading news...</div>
            </div>
          </div>
        </section>

        <!-- Combined Analytics Section -->
        <section class="card p-3 mb-3 shadow-sm" id="combinedAnalyticsSection">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-graph-up-arrow"></i> Combined Analytics</h5>
          </div>
          <div class="chart-container">
            <canvas id="priceSentimentOverlay"></canvas>
          </div>
          <div class="mt-3">
            <p class="text-muted small">Price and sentiment correlation over time</p>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Article Modal -->
  <div class="modal fade" id="articleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="articleModalTitle"></h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="articleModalBody"></div>
      </div>
    </div>
  </div>

  <script>
    // API configuration - Updated for FastAPI
    window.API_BASE = "http://localhost:8080/api/";

    // Global chart variables
    let priceChart = null;
    let sentimentTrendChart = null;
    let indicesChart = null;
    let overlayChart = null;

    // Setup event handlers when DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      setupEventHandlers();
      checkAPIStatus();
      loadDashboard(); // initial load
    });

    function setupEventHandlers() {
      const applySearch = document.getElementById("applySearch");
      if (applySearch) {
        applySearch.addEventListener("click", () => {
          loadDashboard();
        });
      }

      const applyFilters = document.getElementById("applyFilters");
      if (applyFilters) {
        applyFilters.addEventListener("click", () => {
          loadDashboard();
        });
      }

      const btnExportCSV = document.getElementById("btnExportCSV");
      if (btnExportCSV) {
        btnExportCSV.addEventListener("click", exportCurrentViewCSV);
      }

      const btnRunAlerts = document.getElementById("btnRunAlerts");
      if (btnRunAlerts) {
        btnRunAlerts.addEventListener("click", runAlerts);
      }

      const btnWordcloud = document.getElementById("btnWordcloud");
      if (btnWordcloud) {
        btnWordcloud.addEventListener("click", generateWordCloud);
      }

      const btnToggleCandlestick = document.getElementById("btnToggleCandlestick");
      if (btnToggleCandlestick) {
        btnToggleCandlestick.addEventListener("click", toggleCandlestick);
      }
    }

    // Check API status
    async function checkAPIStatus() {
      try {
        const response = await fetch(`${window.API_BASE.replace('/api/', '/health')}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          // API status check removed from topbar per user request
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (err) {
        // API status check removed from topbar per user request
        console.error("API Status Check Failed:", err);
      }
    }

    // Generic API fetch with timeout/backoff + status update
    async function fetchAPI(endpoint, params = {}, { timeout = 8000, retries = 2 } = {}) {
      try {
        const url = new URL(endpoint, window.API_BASE);
        Object.keys(params).forEach(key => {
          if (params[key] !== null && params[key] !== undefined && params[key] !== '') {
            url.searchParams.append(key, params[key]);
          }
        });
        let lastError = null;
        for (let attempt = 0; attempt <= retries; attempt++) {
          try {
            const controller = new AbortController();
            const t = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json' }, signal: controller.signal });
            clearTimeout(t);
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            const data = await response.json();
            if (data.status === 'error') throw new Error(data.error || 'API returned error status');
            return data;
          } catch (e) {
            lastError = e;
            if (attempt < retries) await new Promise(r => setTimeout(r, (attempt + 1) * 1000));
          }
        }
        throw lastError || new Error('Request failed');
      } catch (error) {
        console.error(`API call failed for ${endpoint}:`, error);
        throw error;
      }
    }

    async function loadDashboard() {
      const tickerElement = document.getElementById("tickerSearch");
      const daysElement = document.getElementById("dateRange");
      const filterTickersElement = document.getElementById("filterTickers");
      const sentimentTypeElement = document.getElementById("sentimentType");
      const keywordElement = document.getElementById("keywordFilter");
      const sourceElement = document.getElementById("sourceSelect");
      
      const ticker = tickerElement ? tickerElement.value.trim() : "";
      const days = daysElement ? parseInt(daysElement.value) : 7;
      const tickersFilter = filterTickersElement ? filterTickersElement.value.trim() : "";
      const sentimentType = sentimentTypeElement ? sentimentTypeElement.value : "";
      const keyword = keywordElement ? keywordElement.value.trim() : "";
      const source = sourceElement ? sourceElement.value : "";

      // Load KPIs
      try {
        const summary = await fetchAPI("dashboard");
        document.getElementById("totalCompanies").innerText = summary.total_companies ?? "—";
      } catch (err) {
        console.error("Error fetching summary", err);
        // Set fallback values
        document.getElementById("totalCompanies").innerText = "—";
      }

      // Load other sections
      if (ticker) {
        // If specific ticker is selected, show that ticker
        loadStockPrices(ticker, days);
        // Load company performance using database views (Priority 1)
        loadCompanyPerformance(ticker);
      } else {
        // If no ticker selected, show multiple major stocks
        loadMultipleStocks(days);
      }
      loadIndices(days);
      loadSentimentTrend(ticker, days, sentimentType, keyword, source);
      loadPriceSentimentOverlay(ticker || "AAPL", days);
      loadNewsFeed(ticker || "", days, sentimentType, keyword, source);
    }

    // Cache for company names to avoid repeated API calls
    let companyNameCache = {};

    // Get company name from database based on ticker
    async function getCompanyNameFromDatabase(ticker) {
      if (!ticker) return null;
      
      const formattedTicker = ticker.trim().toUpperCase();
      
      // Check cache first
      if (companyNameCache[formattedTicker]) {
        return companyNameCache[formattedTicker];
      }
      
      try {
        // Fetch company info from database
        const companyData = await fetchAPI(`companies/${formattedTicker}`);
        
        if (companyData.status === 'success' && companyData.company) {
          const companyName = companyData.company.company_name;
          // Cache it for future use
          companyNameCache[formattedTicker] = companyName;
          return companyName;
        }
      } catch (error) {
        console.error(`Error fetching company name for ${formattedTicker}:`, error);
      }
      
      return null;
    }

    // Load company performance using database views (Priority 1: Database Views Integration)
    async function loadCompanyPerformance(ticker) {
      try {
        // The view doesn't filter by ticker, so we need to filter client-side
        const performance = await fetchAPI(`views/company-performance`);
        
        if (performance.status === 'success' && performance.data && performance.data.length > 0) {
          // Find the company matching the ticker
          const data = performance.data.find(c => c.ticker === ticker.toUpperCase());
          if (data) {
            renderCompanyPerformanceCard(data);
          } else {
            const container = document.getElementById('companyPerformanceContent');
            if (container) {
              container.innerHTML = '<p class="text-muted small">Performance data not available for this ticker</p>';
            }
          }
        } else {
          // Clear or show placeholder
          const container = document.getElementById('companyPerformanceContent');
          if (container) {
            container.innerHTML = '<p class="text-muted small">Performance data not available</p>';
          }
        }
      } catch (error) {
        console.error('Error loading company performance:', error);
        const container = document.getElementById('companyPerformanceContent');
        if (container) {
          container.innerHTML = '<p class="text-muted small">Error loading performance data</p>';
        }
      }
    }

    function renderCompanyPerformanceCard(data) {
      const container = document.getElementById('companyPerformanceContent');
      if (!container) return;
      
      // Calculate price change percentage from min/max if available
      let priceChange = null;
      if (data.max_price && data.min_price && data.avg_price) {
        priceChange = ((data.max_price - data.min_price) / data.min_price) * 100;
      }
      
      // Calculate volatility (price range percentage)
      let volatility = null;
      if (data.max_price && data.min_price) {
        volatility = ((data.max_price - data.min_price) / data.avg_price) * 100;
      }
      
      container.innerHTML = `
        <div class="mb-2">
          <strong>Average Price:</strong><br>
          <span class="h5">$${data.avg_price ? data.avg_price.toFixed(2) : 'N/A'}</span>
        </div>
        <div class="mb-2">
          <strong>Price Range:</strong><br>
          <small>High: $${data.max_price ? data.max_price.toFixed(2) : 'N/A'}</small><br>
          <small>Low: $${data.min_price ? data.min_price.toFixed(2) : 'N/A'}</small>
        </div>
        <div class="mb-2">
          <strong>Avg Volume:</strong><br>
          <span>${data.avg_volume ? Math.round(data.avg_volume).toLocaleString() : 'N/A'}</span>
        </div>
        ${volatility !== null ? `
        <div class="mb-2">
          <strong>Volatility:</strong><br>
          <span>${volatility.toFixed(2)}%</span>
        </div>
        ` : ''}
        ${data.price_records_count ? `
        <div class="mt-3 pt-2 border-top">
          <small class="text-muted">Records: ${data.price_records_count}</small><br>
          ${data.last_date ? `<small class="text-muted">Last: ${new Date(data.last_date).toLocaleDateString()}</small>` : ''}
        </div>
        ` : ''}
      `;
    }

    // Updated stock prices function for FastAPI
    async function loadStockPrices(ticker = "AAPL", days = 7) {
      try {
        // show skeleton while loading
        const sk = document.getElementById('priceChartSkeleton'); if (sk) sk.style.display = 'block';
        const data = await fetchAPI("stock_analysis", { ticker, days });
        const analysis = data.analysis || [];

        if (analysis.length === 0) {
          console.warn(`No stock data found for ticker: ${ticker}`);
          return;
        }

        const labels = analysis.slice().reverse().map(d => d.date);
        const close = analysis.slice().reverse().map(d => parseFloat(d.close_price || 0));

        // Use correct column names from FastAPI
        const ma5 = analysis.slice().reverse().map(d => d.ma_5 ? parseFloat(d.ma_5) : null);
        const ma20 = analysis.slice().reverse().map(d => d.ma_20 ? parseFloat(d.ma_20) : null);
        const ma50 = analysis.slice().reverse().map(d => d.ma_50 ? parseFloat(d.ma_50) : null);
        const ma200 = analysis.slice().reverse().map(d => d.ma_200 ? parseFloat(d.ma_200) : null);

        const ctx = document.getElementById("priceChart").getContext("2d");
        if (priceChart) priceChart.destroy();

        priceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              { label: `${ticker} Close`, data: close, borderColor: "rgb(34,139,34)", tension:0.1, pointRadius: 2, fill: false },
              { label: "MA 5", data: ma5, borderColor: "rgb(30,144,255)", borderDash: [5,5], tension:0.1, pointRadius: 0, fill: false },
              { label: "MA 20", data: ma20, borderColor: "rgb(255,165,0)", borderDash: [5,5], tension:0.1, pointRadius: 0, fill: false },
              { label: "MA 50", data: ma50, borderColor: "rgb(255,99,132)", borderDash: [5,5], tension:0.1, pointRadius: 0, fill: false },
              { label: "MA 200", data: ma200, borderColor: "rgb(128,0,128)", borderDash: [10,5], tension:0.1, pointRadius: 0, fill: false }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { display: true, title: { display: true, text: 'Date' } },
              y: { display: true, title: { display: true, text: 'Price ($)' } }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: $${ctx.formattedValue}`
                }
              },
              legend: { display: true, position: 'top' }
            }
          }
        });

        // hide skeleton and update badges
        if (sk) sk.style.display = 'none';
        const ds = document.getElementById('dataSourceBadge');
        if (ds) ds.textContent = (data.data_source || '—').replace('_', ' ');
        const lu = document.getElementById('lastUpdated');
        if (lu) lu.textContent = `Updated ${new Date().toLocaleTimeString()}`;

      } catch (err) {
    console.error("Error loading stock prices", err);
        const sk = document.getElementById('priceChartSkeleton'); if (sk) sk.style.display = 'none';
      }
    }

    // Load multiple major stocks for overview
    async function loadMultipleStocks(days = 7) {
      try {
        // show skeleton while loading
        const sk = document.getElementById('priceChartSkeleton'); if (sk) sk.style.display = 'block';
        
        // Major stocks to show
        const majorStocks = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA'];
        const stockData = {};
        
        // Fetch data for each stock
        for (const ticker of majorStocks) {
          try {
            const data = await fetchAPI("stock_analysis", { ticker, days });
            if (data.analysis && data.analysis.length > 0) {
              stockData[ticker] = data.analysis;
            }
          } catch (err) {
            console.warn(`Failed to load data for ${ticker}:`, err);
          }
        }
        
        if (Object.keys(stockData).length === 0) {
          console.warn("No stock data available for any major stocks");
          return;
        }
        
        // Create comparison chart
        const ctx = document.getElementById("priceChart").getContext("2d");
        if (priceChart) priceChart.destroy();
        
        // Use the first stock's dates as labels
        const firstStock = Object.keys(stockData)[0];
        const labels = stockData[firstStock].slice().reverse().map(d => d.date);
        
        // Create datasets for each stock
        const datasets = Object.entries(stockData).map(([ticker, data], index) => {
          const colors = [
            'rgb(75, 192, 192)',   // Teal
            'rgb(255, 99, 132)',   // Red
            'rgb(54, 162, 235)',   // Blue
            'rgb(255, 205, 86)',   // Yellow
            'rgb(153, 102, 255)'   // Purple
          ];
          
          return {
            label: ticker,
            data: data.slice().reverse().map(d => parseFloat(d.close_price || 0)),
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            tension: 0.1,
            fill: false
          };
        });
        
        priceChart = new Chart(ctx, {
          type: "line",
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: "Major Stocks Performance Comparison" },
              legend: { display: true, position: 'top' }
            },
            scales: {
              y: { 
                beginAtZero: false, 
                title: { display: true, text: "Price ($)" },
                // Improve scaling for flat charts
                ticks: {
                  callback: function(value) {
                    return '$' + value.toFixed(2);
                  }
                },
                // Add padding to make flat charts more visible
                afterDataLimits: function(scale) {
                  const range = scale.max - scale.min;
                  if (range < scale.max * 0.01) { // If range is less than 1% of max value
                    const padding = scale.max * 0.02; // Add 2% padding
                    scale.min = Math.max(0, scale.min - padding);
                    scale.max = scale.max + padding;
                  }
                }
              },
              x: { title: { display: true, text: "Date" } }
            }
          }
        });
        
        // hide skeleton and update badges
        if (sk) sk.style.display = 'none';
        const ds = document.getElementById('dataSourceBadge');
        if (ds) ds.textContent = 'Multiple Stocks';
        const lu = document.getElementById('lastUpdated');
        if (lu) lu.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        
      } catch (err) {
        console.error("Error loading multiple stocks", err);
        const sk = document.getElementById('priceChartSkeleton'); if (sk) sk.style.display = 'none';
      }
    }

    // Updated indices function for FastAPI
    async function loadIndices(days = 30) {
      try {
        const data = await fetchAPI("indices", { days });

        if (!data.indices || data.indices.length === 0) {
          console.warn("No indices data available");
          return;
        }

        const ctx = document.getElementById("indicesChart").getContext("2d");
        if (indicesChart) indicesChart.destroy();

        const datasets = data.indices.map((index, i) => ({
          label: index.name,
          data: index.values,
          borderColor: [`rgb(255,99,132)`, `rgb(54,162,235)`, `rgb(255,205,86)`][i % 3],
          tension: 0.1,
          pointRadius: 1,
          fill: false
        }));

        indicesChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.trend.map(t => t.date),
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { 
                display: true, 
                title: { display: true, text: 'Index Value' },
                // Improve scaling for flat index charts
                afterDataLimits: function(scale) {
                  const range = scale.max - scale.min;
                  if (range < scale.max * 0.01) { // If range is less than 1% of max value
                    const padding = scale.max * 0.02; // Add 2% padding
                    scale.min = Math.max(0, scale.min - padding);
                    scale.max = scale.max + padding;
                  }
                }
              }
            },
            plugins: {
              legend: { display: true, position: 'top' }
            }
          }
        });

        // Update index cards
        const indexCards = document.getElementById("indexCards");
        indexCards.innerHTML = "";
        (data.summary || []).forEach(index => {
          const card = document.createElement("div");
          card.className = "card p-2 text-center small";
          card.style.minWidth = "120px";
          const changeClass = index.change_percent >= 0 ? "text-success" : "text-danger";
          card.innerHTML = `
            <div><strong>${index.name}</strong></div>
            <div class="${changeClass}">${index.change_percent >= 0 ? '+' : ''}${index.change_percent}%</div>
          `;
          indexCards.appendChild(card);
        });

      } catch (err) {
        console.error("Error loading indices", err);
      }
    }

    // Updated sentiment trend function for FastAPI
    async function loadSentimentTrend(ticker = "", days = 7, sentimentType = "", keyword = "", source = "") {
      try {
        console.log("Loading sentiment trend with params:", { ticker, days, sentimentType, keyword, source });
        const data = await fetchAPI("sentiment", { ticker, days, live: true });
        console.log("Sentiment API response:", data);

        const ctx = document.getElementById("sentimentTrendChart").getContext("2d");
        if (sentimentTrendChart) sentimentTrendChart.destroy();

        const trends = data.trends || [];
        const labels = trends.map(t => t._id ? t._id.date : t.date);
        const sentiments = trends.map(t => t.avg_sentiment);

        // Handle no data case - show empty chart
        if (trends.length === 0) {
          sentimentTrendChart = new Chart(ctx, {
            type: "line",
            data: { labels: [], datasets: [] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { display: false },
                x: { display: false }
              }
            }
          });
          return;
        }

        sentimentTrendChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Average Sentiment",
              data: sentiments,
              borderColor: "rgb(75,192,192)",
              backgroundColor: "rgba(75,192,192,0.1)",
              tension: 0.1,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                min: -1,
                max: 1,
                title: { display: true, text: 'Sentiment Score' },
                // Improve scaling for flat sentiment charts
                afterDataLimits: function(scale) {
                  const range = scale.max - scale.min;
                  if (range < 0.1) { // If sentiment range is very small
                    const padding = 0.05; // Add padding
                    scale.min = Math.max(-1, scale.min - padding);
                    scale.max = Math.min(1, scale.max + padding);
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: (ctx) => `Sentiment: ${ctx.parsed.y.toFixed(3)}`
                }
              }
            }
          }
        });

        // Update statistics - show if we have data
        const stats = data.statistics || {};
        const highlights = document.getElementById("topicHighlights");
        
        if (stats.total_articles > 0) {
          highlights.innerHTML = `
            <div class="row">
              <div class="col-4 text-center">
                <div class="text-success"><strong>${stats.positive_count || 0}</strong></div>
                <div>Positive</div>
              </div>
              <div class="col-4 text-center">
                <div class="text-muted"><strong>${stats.neutral_count || 0}</strong></div>
                <div>Neutral</div>
              </div>
              <div class="col-4 text-center">
                <div class="text-danger"><strong>${stats.negative_count || 0}</strong></div>
                <div>Negative</div>
              </div>
            </div>
            <div class="text-center mt-2">
              <small class="text-muted">Total: ${stats.total_articles} | Avg: ${(stats.avg_sentiment || 0).toFixed(3)}</small>
            </div>
          `;
        } else {
          // Show empty statistics
          highlights.innerHTML = `<div class="text-center text-muted">No data</div>`;
        }

      } catch (err) {
        console.error("Error loading sentiment trend", err);
      }
    }

    // Updated news feed function for FastAPI
    async function loadNewsFeed(ticker = "", days = 7, sentimentType = "", keyword = "", source = "") {
      try {
        console.log("Loading news feed with params:", { ticker, days, sentimentType, keyword, source });
        
        // Ensure ticker is properly formatted (uppercase, trimmed)
        const formattedTicker = ticker ? ticker.trim().toUpperCase() : "";
        
        // Get company name from database for better article matching
        let companyName = null;
        let searchTerms = formattedTicker ? [formattedTicker] : [];
        
        if (formattedTicker) {
          companyName = await getCompanyNameFromDatabase(formattedTicker);
          if (companyName) {
            // Add company name and variations to search terms
            searchTerms.push(companyName.toUpperCase());
            // Also add common variations (e.g., "Apple Inc." -> "Apple", "Apple Inc")
            const nameVariations = companyName.split(/[\s,]+/).filter(part => part.length > 2);
            searchTerms.push(...nameVariations.map(v => v.toUpperCase()));
          }
        }
        
        const data = await fetchAPI("news", {
          ticker: formattedTicker,
          days,
          sentiment: sentimentType,
          limit: 20, // Get more articles to filter from
          live: true
        });
        console.log("News API response:", data);

        const newsFeed = document.getElementById("newsFeed");
        if (!newsFeed) {
          console.error("News feed element not found!");
          return;
        }
        newsFeed.innerHTML = "";

        let articles = data.articles || [];
        console.log("Articles count before filtering:", articles.length, "for ticker:", formattedTicker);

        // Filter articles to only show those that mention the ticker or company name
        let filteredArticles = articles;
        let hasTickerSpecificNews = false;
        
        if (formattedTicker && searchTerms.length > 0) {
          filteredArticles = articles.filter(article => {
            // Check if article has ticker field matching
            const articleTicker = (article.ticker || "").toUpperCase();
            if (articleTicker === formattedTicker) {
              hasTickerSpecificNews = true;
              return true;
            }
            
            // Check if title or content contains any search term (ticker or company name)
            const title = (article.title || "").toUpperCase();
            const content = (article.content || "").toUpperCase();
            
            const matches = searchTerms.some(term => {
              // Use word boundaries to avoid partial matches (e.g., "APP" matching "APPLE")
              const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const regex = new RegExp(`\\b${escapedTerm}\\b`, 'i');
              return regex.test(title) || regex.test(content);
            });
            
            if (matches) {
              hasTickerSpecificNews = true;
            }
            
            return matches;
          });
          
          console.log("Articles count after filtering:", filteredArticles.length);
          
          // If we filtered out all articles but had some originally, show a message
          if (filteredArticles.length === 0 && articles.length > 0) {
            const noMatchItem = document.createElement("div");
            noMatchItem.className = "list-group-item list-group-item-warning";
            const companyText = companyName ? `${formattedTicker} (${companyName})` : formattedTicker;
            noMatchItem.innerHTML = `
              <small><i class="bi bi-exclamation-triangle"></i> No articles found that specifically mention ${companyText}. Showing general financial news instead.</small>
            `;
            newsFeed.appendChild(noMatchItem);
            // Show general articles if no matches
            filteredArticles = articles.slice(0, 5); // Limit to 5 general articles
            hasTickerSpecificNews = false;
          }
        } else if (formattedTicker && articles.length > 0) {
          // Check if any article has the ticker in its ticker field
          hasTickerSpecificNews = articles.some(article => {
            const articleTicker = (article.ticker || "").toUpperCase();
            return articleTicker === formattedTicker;
          });
        }
        
        // Show indicator
        if (formattedTicker && !hasTickerSpecificNews && filteredArticles.length > 0) {
          const header = document.createElement("div");
          header.className = "list-group-item list-group-item-info";
          const companyText = companyName ? `${formattedTicker} (${companyName})` : formattedTicker;
          header.innerHTML = `<small><i class="bi bi-info-circle"></i> Showing general financial news (no specific news found for ${companyText})</small>`;
          newsFeed.appendChild(header);
        } else if (formattedTicker && hasTickerSpecificNews) {
          const header = document.createElement("div");
          header.className = "list-group-item list-group-item-success";
          const companyText = companyName ? `${formattedTicker} (${companyName})` : formattedTicker;
          header.innerHTML = `<small><i class="bi bi-check-circle"></i> News for ${companyText}</small>`;
          newsFeed.appendChild(header);
        }

        if (filteredArticles.length === 0) {
          if (formattedTicker) {
            const companyText = companyName ? `${formattedTicker} (${companyName})` : formattedTicker;
            newsFeed.innerHTML = `<div class="list-group-item text-muted">No articles found for ${companyText}</div>`;
          } else {
            newsFeed.innerHTML = '<div class="list-group-item text-muted">No articles</div>';
          }
          return;
        }

        filteredArticles.forEach(article => {
          const item = document.createElement("div");
          item.className = "list-group-item list-group-item-action";

          const sentiment = article.sentiment_analysis?.overall_score || 0;
          const sentimentClass = sentiment > 0.1 ? "sent-pos" : (sentiment < -0.1 ? "sent-neg" : "sent-ntrl");
          const sentimentText = sentiment > 0.1 ? "+" : (sentiment < -0.1 ? "-" : "○");
          
          // Check if article actually mentions the ticker or company
          const articleTicker = (article.ticker || "").toUpperCase();
          const title = (article.title || "").toUpperCase();
          const content = (article.content || "").toUpperCase();
          
          let isTickerSpecific = false;
          if (formattedTicker && searchTerms.length > 0) {
            isTickerSpecific = articleTicker === formattedTicker || 
              searchTerms.some(term => {
                const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b${escapedTerm}\\b`, 'i');
                return regex.test(title) || regex.test(content);
              });
          }
          
          // Show ticker badge only if article is actually ticker-specific
          const tickerBadge = isTickerSpecific && formattedTicker
            ? `<span class="badge bg-primary ms-2">${formattedTicker}</span>` 
            : "";

          item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${article.title || 'No title'}${tickerBadge}</h6>
                <p class="mb-1 small">${(article.content || '').substring(0, 120)}...</p>
                <small class="text-muted">${article.source || 'Unknown'} • ${article.published_date || 'Unknown date'}</small>
              </div>
              <small class="${sentimentClass} ms-2">${sentimentText}</small>
            </div>
          `;

          item.addEventListener("click", () => showArticleModal(article));
          newsFeed.appendChild(item);
        });

      } catch (err) {
        console.error("Error loading news feed", err);
        const newsFeedEl = document.getElementById("newsFeed");
        if (newsFeedEl) {
          newsFeedEl.innerHTML = '<div class="list-group-item text-muted">Error loading news</div>';
        }
      }
    }

    // Updated alerts function for FastAPI
    async function runAlerts() {
      try {
        const data = await fetchAPI("alerts", { limit: 5 });
        const alerts = document.getElementById("alertsList");
        alerts.innerHTML = "";

        const alertsData = data.alerts || [];

        if (alertsData.length === 0) {
          alerts.innerHTML = '<div class="alert alert-info small">No alerts at this time</div>';
          return;
        }

        alertsData.forEach(alert => {
          const div = document.createElement("div");
          const severityClass = alert.severity === 'high' ? 'alert-danger' :
                               alert.severity === 'medium' ? 'alert-warning' : 'alert-info';
          div.className = `alert ${severityClass} small mb-2`;
          div.innerHTML = `
            <strong>${alert.ticker}</strong><br>
            ${alert.message}
            <small class="d-block mt-1 text-muted">${alert.type}</small>
          `;
          alerts.appendChild(div);
        });

      } catch (err) {
        console.error("Error running alerts", err);
        document.getElementById("alertsList").innerHTML = '<div class="alert alert-danger small">Error loading alerts</div>';
      }
    }

    // Updated timeline function for FastAPI
    async function loadTimeline(ticker = "", days = 30) {
      try {
        const data = await fetchAPI("timeline", { ticker, days });
        const timeline = document.getElementById("trendTimeline");

        const timelineData = data.timeline || [];

        if (timelineData.length === 0) {
          timeline.innerHTML = '<div class="text-muted">No data</div>';
          return;
        }

        timeline.innerHTML = "<h6>Recent Activity</h6>";

        timelineData.slice(0, 10).forEach(item => {
          const div = document.createElement("div");
          div.className = "border-bottom py-2 small";

          const change = item.price_change_pct || 0;
          const changeClass = change >= 0 ? "text-success" : "text-danger";
          const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;

          div.innerHTML = `
            <div class="d-flex justify-content-between">
              <strong>${item.ticker}</strong>
              <span class="${changeClass}">${changeText}</span>
            </div>
            <div class="text-muted">
              $${item.close_price} • ${item.date}
            </div>
          `;
          timeline.appendChild(div);
        });

      } catch (err) {
        console.error("Error loading timeline", err);
        document.getElementById("trendTimeline").innerHTML = '<div class="text-muted">Error loading timeline</div>';
      }
    }

    // Price-sentiment overlay chart
    async function loadPriceSentimentOverlay(ticker = "AAPL", days = 30) {
      try {
        // Get both stock and sentiment data
        const [stockData, sentimentData] = await Promise.all([
          fetchAPI("stock_analysis", { ticker, days }),
          fetchAPI("sentiment", { ticker, days, live: true })
        ]);

        const ctx = document.getElementById("priceSentimentOverlay").getContext("2d");
        if (overlayChart) overlayChart.destroy();

        const stockAnalysis = stockData.analysis || [];
        const sentimentTrends = sentimentData.trends || [];

        if (stockAnalysis.length === 0) {
          console.warn("No data for overlay chart");
          return;
        }

        const labels = stockAnalysis.slice().reverse().map(d => d.date);
        const prices = stockAnalysis.slice().reverse().map(d => parseFloat(d.close_price || 0));

        // Match sentiment data to dates
        const sentiments = labels.map(date => {
          const sentimentDay = sentimentTrends.find(s => (s._id ? s._id.date : s.date) === date);
          return sentimentDay ? sentimentDay.avg_sentiment : null;
        });

        overlayChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: `${ticker} Price`,
                data: prices,
                borderColor: "rgb(34,139,34)",
                yAxisID: 'y',
                tension: 0.1
              },
              {
                label: "Sentiment",
                data: sentiments,
                borderColor: "rgb(255,99,132)",
                yAxisID: 'y1',
                tension: 0.1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: 'Price ($)' },
                // Improve scaling for flat price charts
                afterDataLimits: function(scale) {
                  const range = scale.max - scale.min;
                  if (range < scale.max * 0.01) { // If range is less than 1% of max value
                    const padding = scale.max * 0.02; // Add 2% padding
                    scale.min = Math.max(0, scale.min - padding);
                    scale.max = scale.max + padding;
                  }
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                min: -1,
                max: 1,
                title: { display: true, text: 'Sentiment' },
                grid: { drawOnChartArea: false }
              }
            }
          }
        });

      } catch (err) {
        console.error("Error loading overlay chart", err);
      }
    }

    // Utility functions
    function showArticleModal(article) {
      document.getElementById("articleModalTitle").textContent = article.title || 'Article';
      document.getElementById("articleModalBody").innerHTML = `
        <p><strong>Source:</strong> ${article.source || 'Unknown'}</p>
        <p><strong>Date:</strong> ${article.published_date || 'Unknown'}</p>
        <p><strong>Ticker:</strong> ${article.ticker || 'N/A'}</p>
        <div>${article.content || 'No content available'}</div>
      `;

      const modal = new bootstrap.Modal(document.getElementById("articleModal"));
      modal.show();
    }

    function toggleCandlestick() {
      alert("Candlestick view: Feature coming soon");
    }

    function exportCurrentViewCSV() {
      alert("CSV export: Feature coming soon");
    }

    // Word cloud function removed per user request

    // Sector heatmap function removed per user request

    // Auto-refresh every 5 minutes
    setInterval(() => {
      console.log("Auto-refreshing dashboard...");
      loadDashboard();
    }, 5 * 60 * 1000);
  </script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Utility Scripts -->
  <script src="js/utils.js"></script>
  <script src="js/error-handler.js"></script>
  <script src="js/loading-states.js"></script>
  
  <!-- Enhanced Dashboard Scripts -->
  <script src="js/dashboard-enhanced.js"></script>
  
  <!-- Real-Time Updates Scripts -->
  <script src="js/realtime-updates.js"></script>
  
  <!-- Mobile Responsiveness Scripts -->
  <script src="js/mobile-responsive.js"></script>
  
  <!-- Accessibility Scripts -->
  <script src="js/accessibility.js"></script>
  
  <!-- Authentication Scripts -->
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  
  <script>
    // Enhanced dashboard functions
    async function refreshAnalytics() {
      if (window.dashboardEnhanced) {
        window.utils.showLoadingOverlay('Refreshing analytics...');
        try {
          await window.dashboardEnhanced.loadAdvancedAnalytics();
          window.utils.showToast('Analytics refreshed successfully', 'success');
        } catch (error) {
          window.errorHandler.handleApiError(error, 'Refreshing analytics');
        } finally {
          window.utils.hideLoadingOverlay();
        }
      }
    }
    
    async function refreshMaterializedView() {
      window.utils.showLoadingOverlay('Refreshing materialized view...');
      try {
        await window.api.post('/warehouse/materialized-view/refresh');
        if (window.dashboardEnhanced) {
          await window.dashboardEnhanced.loadMaterializedViews();
        }
        window.utils.showToast('Materialized view refreshed successfully', 'success');
      } catch (error) {
        window.errorHandler.handleApiError(error, 'Refreshing materialized view');
      } finally {
        window.utils.hideLoadingOverlay();
      }
    }
    
    function toggleAnalytics() {
      const content = document.getElementById('advancedAnalyticsContent');
      const icon = document.getElementById('analyticsToggleIcon');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
      } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
      }
    }
  </script>
</body>
</html>