<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Test - MarketPulse Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
            color: #111827;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: #111827;
        }
        
        .input-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
        }
        
        #tickerInput {
            flex: 1;
            max-width: 300px;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        
        #tickerInput:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        button {
            padding: 0.75rem 1.5rem;
            background: #111827;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }
        
        button:hover {
            background: #1f2937;
        }
        
        #results {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        #results p {
            margin: 0;
        }
        
        .test-section { 
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .test-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #111827;
        }
        
        .list-group { 
            max-height: 400px;
            overflow-y: auto;
        }
        
        .list-group-item { 
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: #f9fafb;
            transition: all 0.2s ease;
        }
        
        .list-group-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .list-group-item h6 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #111827;
        }
        
        .list-group-item p {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .list-group-item small {
            font-size: 0.8125rem;
        }
        
        .text-muted {
            color: #6b7280;
        }
        
        .sent-pos { 
            color: #16a34a;
            font-weight: 600;
        }
        
        .sent-neg { 
            color: #dc2626;
            font-weight: 600;
        }
        
        .sent-ntrl { 
            color: #6b7280;
            font-weight: 600;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .mb-1 {
            margin-bottom: 0.25rem;
        }
        
        .small {
            font-size: 0.875rem;
        }
        
        canvas {
            max-height: 300px;
        }
        
        .row {
            display: flex;
            gap: 1rem;
            margin: 0 -0.5rem;
        }
        
        .col-4 {
            flex: 1;
            padding: 0 0.5rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-success {
            color: #16a34a;
        }
        
        .text-danger {
            color: #dc2626;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .stats-card {
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stats-card strong {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .stats-card div:last-child {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        /* Scrollbar styling */
        .list-group::-webkit-scrollbar {
            width: 8px;
        }
        
        .list-group::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .list-group::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        
        .list-group::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Frontend Data Test</h1>
        
        <div class="input-group">
            <input id="tickerInput" placeholder="Enter ticker (e.g., BA, AGNC, MMM)">
            <button onclick="testFrontend()">Test Frontend</button>
        </div>
        
        <div id="results"></div>
        
        <div class="test-section">
            <h3>News Feed</h3>
            <div id="newsFeed" class="list-group"></div>
        </div>
        
        <div class="test-section">
            <h3>Sentiment Chart</h3>
            <canvas id="sentimentChart"></canvas>
        </div>
        
        <div class="test-section">
            <h3>Sentiment Statistics</h3>
            <div id="sentimentStats"></div>
        </div>
    </div>
    
    <script>
        // Replicate the exact same API configuration as index.html
        // Auto-detect API base from current URL (works for any port)
        if (!window.API_BASE) {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port || (protocol === 'https:' ? '443' : '80');
            window.API_BASE = `${protocol}//${hostname}:${port}/api/`;
        }
        
        // Replicate the exact same fetchAPI function from index.html
        async function fetchAPI(endpoint, params = {}, { timeout = 8000, retries = 2 } = {}) {
            try {
                const url = new URL(endpoint, window.API_BASE);
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined && params[key] !== '') {
                        url.searchParams.append(key, params[key]);
                    }
                });
                let lastError = null;
                for (let attempt = 0; attempt <= retries; attempt++) {
                    try {
                        const controller = new AbortController();
                        const t = setTimeout(() => controller.abort(), timeout);
                        const response = await fetch(url, { 
                            method: 'GET', 
                            headers: { 'Content-Type': 'application/json' }, 
                            signal: controller.signal 
                        });
                        clearTimeout(t);
                        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        const data = await response.json();
                        if (data.status === 'error') throw new Error(data.error || 'API returned error status');
                        return data;
                    } catch (e) {
                        lastError = e;
                        if (attempt < retries) await new Promise(r => setTimeout(r, (attempt + 1) * 1000));
                    }
                }
                throw lastError || new Error('Request failed');
            } catch (error) {
                console.error(`API call failed for ${endpoint}:`, error);
                throw error;
            }
        }
        
        async function testFrontend() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            const results = document.getElementById('results');
            
            if (!ticker) {
                results.innerHTML = '<p style="color: red;">Please enter a ticker</p>';
                return;
            }
            
            results.innerHTML = `<p>Testing ${ticker}...</p>`;
            
            try {
                // Test news feed
                console.log('Testing news feed...');
                await loadNewsFeed(ticker, 7, "", "", "");
                
                // Test sentiment
                console.log('Testing sentiment...');
                await loadSentimentTrend(ticker, 7, "", "", "");
                
                results.innerHTML = `<p style="color: green;">✅ Test completed for ${ticker}. Check the sections below.</p>`;
                
            } catch (error) {
                console.error('Test error:', error);
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        // Replicate the exact same loadNewsFeed function from index.html
        async function loadNewsFeed(ticker = "", days = 7, sentimentType = "", keyword = "", source = "") {
            try {
                console.log("Loading news feed with params:", { ticker, days, sentimentType, keyword, source });
                const data = await fetchAPI("news", {
                    ticker,
                    days,
                    sentiment: sentimentType,
                    limit: 10,
                    live: true
                });
                console.log("News API response:", data);

                const newsFeed = document.getElementById("newsFeed");
                if (!newsFeed) {
                    console.error("News feed element not found!");
                    return;
                }
                newsFeed.innerHTML = "";

                const articles = data.articles || [];
                console.log("Articles count:", articles.length);

                if (articles.length === 0) {
                    newsFeed.innerHTML = '<div class="list-group-item text-muted">No news articles found</div>';
                    return;
                }

                articles.forEach(article => {
                    const item = document.createElement("div");
                    item.className = "list-group-item list-group-item-action";

                    const sentiment = article.sentiment_analysis?.overall_score || 0;
                    const sentimentClass = sentiment > 0.1 ? "sent-pos" : (sentiment < -0.1 ? "sent-neg" : "sent-ntrl");
                    const sentimentText = sentiment > 0.1 ? "+" : (sentiment < -0.1 ? "-" : "○");

                    item.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${article.title || 'No title'}</h6>
                            <small class="${sentimentClass}">${sentimentText}</small>
                        </div>
                        <p class="mb-1 small">${(article.content || '').substring(0, 120)}...</p>
                        <small class="text-muted">${article.source || 'Unknown'} • ${article.published_date || 'Unknown date'}</small>
                    `;
                    newsFeed.appendChild(item);
                });

            } catch (error) {
                console.error("Error loading news feed:", error);
                const newsFeed = document.getElementById("newsFeed");
                if (newsFeed) {
                    newsFeed.innerHTML = '<div class="list-group-item text-muted">Error loading news</div>';
                }
            }
        }
        
        // Replicate the exact same loadSentimentTrend function from index.html
        async function loadSentimentTrend(ticker = "", days = 7, sentimentType = "", keyword = "", source = "") {
            try {
                console.log("Loading sentiment trend with params:", { ticker, days, sentimentType, keyword, source });
                const data = await fetchAPI("sentiment", { ticker, days, live: true });
                console.log("Sentiment API response:", data);

                const ctx = document.getElementById("sentimentChart").getContext("2d");
                const trends = data.trends || [];
                const labels = trends.map(t => t._id ? t._id.date : t.date);
                const sentiments = trends.map(t => t.avg_sentiment);

                if (trends.length === 0) {
                    ctx.fillText("No sentiment data available", 10, 50);
                    return;
                }

                new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Sentiment Score",
                            data: sentiments,
                            borderColor: "rgb(75, 192, 192)",
                            backgroundColor: "rgba(75, 192, 192, 0.2)",
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: -1,
                                max: 1
                            }
                        }
                    }
                });

                // Update statistics
                const stats = data.statistics || {};
                const statsDiv = document.getElementById("sentimentStats");
                
                if (stats.total_articles > 0) {
                    statsDiv.innerHTML = `
                        <div class="row">
                            <div class="col-4 text-center">
                                <div class="text-success"><strong>${stats.positive_count || 0}</strong></div>
                                <div>Positive</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="text-muted"><strong>${stats.neutral_count || 0}</strong></div>
                                <div>Neutral</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="text-danger"><strong>${stats.negative_count || 0}</strong></div>
                                <div>Negative</div>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">Total: ${stats.total_articles} | Avg: ${(stats.avg_sentiment || 0).toFixed(3)}</small>
                        </div>
                    `;
                } else {
                    statsDiv.innerHTML = `<div class="text-center text-muted">No sentiment data available</div>`;
                }

            } catch (err) {
                console.error("Error loading sentiment trend", err);
            }
        }
    </script>
</body>
</html>